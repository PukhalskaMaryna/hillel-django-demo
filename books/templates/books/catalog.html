{% extends "base.html" %}
{% load static %}

{% block title %}–ö–∞—Ç–∞–ª–æ–≥ –∫–Ω–∏–≥{% endblock %}

{% block content %}
  <h1>–ö–∞—Ç–∞–ª–æ–≥ üìö</h1>

  <form method="get" style="margin:.5rem 0;">
    <input type="text" name="q" value="{{ q }}" placeholder="–ü–æ—à—É–∫ –∑–∞ –Ω–∞–∑–≤–æ—é" />
    <button type="submit">–ó–Ω–∞–π—Ç–∏</button>
    {% if q %}<small>–ó–Ω–∞–π–¥–µ–Ω–æ: {{ total }}</small>{% endif %}
  </form>

  <section class="card" style="margin-top:1rem;">
    <h3>–î–æ–¥–∞—Ç–∏ –∫–Ω–∏–≥—É (AJAX)</h3>
    <form id="createBookForm">
      {% csrf_token %}
      <div style="display:flex; gap:.5rem; flex-wrap:wrap;">
        <input type="text" name="title" placeholder="–ù–∞–∑–≤–∞" required style="flex:2;">
        <input type="number" step="0.01" name="price" placeholder="–¶—ñ–Ω–∞" required style="flex:1; max-width:180px;">
        <button class="btn" type="submit">–°—Ç–≤–æ—Ä–∏—Ç–∏</button>
      </div>
      <p id="createBookMsg" class="small" style="margin:.5rem 0 0;"></p>
    </form>
  </section>

  {% if books %}
    <table style="width:100%; border-collapse: collapse; margin-top: 1rem;">
      <thead>
        <tr><th style="text-align:left; padding:.5rem; border-bottom:1px solid #223150;">–ù–∞–∑–≤–∞</th>
            <th style="text-align:left; padding:.5rem; border-bottom:1px solid #223150;">–¶—ñ–Ω–∞</th>
            <th style="text-align:left; padding:.5rem; border-bottom:1px solid #223150;"><small>–î–æ–¥–∞–Ω–æ</small></th></tr>
      </thead>
      <tbody id="bookRows">
        {% for b in books %}
          <tr>
            <td style="padding:.5rem; border-bottom:1px solid #223150;">
              <a href="{% url 'books:book_detail' b.slug %}">{{ b.title }}</a>
            </td>
            <td style="padding:.5rem; border-bottom:1px solid #223150;">{{ b.price }} –≥—Ä–Ω</td>
            <td style="padding:.5rem; border-bottom:1px solid #223150;"><small>{{ b.created_at|date:"d.m.Y H:i" }}</small></td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p class="small">–ü–æ–∫–∏ –ø–æ—Ä–æ–∂–Ω—å–æ. –î–æ–¥–∞–π –ø–µ—Ä—à—ñ –∫–Ω–∏–≥–∏ —á–µ—Ä–µ–∑ —Ñ–æ—Ä–º—É –≤–∏—â–µ –∞–±–æ —á–µ—Ä–µ–∑ <a href="/admin/">–∞–¥–º—ñ–Ω–∫—É</a>.</p>
  {% endif %}

  <nav style="margin-top:1rem; display:flex; gap:.5rem; align-items:center;">
    {% if page_obj.has_previous %}
      <a href="?q={{ q }}&page=1">¬´ –ü–µ—Ä—à–∞</a>
      <a href="?q={{ q }}&page={{ page_obj.previous_page_number }}">‚Äπ –ü–æ–ø–µ—Ä–µ–¥–Ω—è</a>
    {% endif %}
    <span>–°—Ç–æ—Ä—ñ–Ω–∫–∞ {{ page_obj.number }} –∑ {{ page_obj.paginator.num_pages }}</span>
    {% if page_obj.has_next %}
      <a href="?q={{ q }}&page={{ page_obj.next_page_number }}">–ù–∞—Å—Ç—É–ø–Ω–∞ ‚Ä∫</a>
      <a href="?q={{ q }}&page={{ page_obj.paginator.num_pages }}">–û—Å—Ç–∞–Ω–Ω—è ¬ª</a>
    {% endif %}
  </nav>

  <p style="margin-top:1rem;"><a href="{% url 'books:bookstore_home' %}">–ù–∞ –≥–æ–ª–æ–≤–Ω—É –∫–Ω–∏–≥–∞—Ä–Ω—ñ</a></p>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('createBookForm');
  const msg  = document.getElementById('createBookMsg');
  const rows = document.getElementById('bookRows');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    msg.textContent = '–°—Ç–≤–æ—Ä—é—é...';

    const title = form.querySelector('input[name="title"]').value.trim();
    const price = form.querySelector('input[name="price"]').value.trim();
    const csrftoken = form.querySelector('input[name="csrfmiddlewaretoken"]').value;

    try {
      const resp = await fetch("{% url 'books:api_book_create' %}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken,
        },
        body: JSON.stringify({ title, price })
      });
      const data = await resp.json();
      if (!resp.ok) throw data;

      msg.textContent = `‚úÖ –î–æ–¥–∞–Ω–æ: ${data.title} (${data.price} –≥—Ä–Ω)`;

      // –¥–æ–¥–∞–º–æ —Ä—è–¥–æ—á–æ–∫ —É —Ç–∞–±–ª–∏—Ü—é –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è (—è–∫—â–æ —Ç–∞–±–ª–∏—Ü—è —î)
      if (rows) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="padding:.5rem; border-bottom:1px solid #223150;">
            <a href="/books/catalog/${data.slug}/">${data.title}</a>
          </td>
          <td style="padding:.5rem; border-bottom:1px solid #223150;">${data.price} –≥—Ä–Ω</td>
          <td style="padding:.5rem; border-bottom:1px solid #223150;"><small>—â–æ–π–Ω–æ</small></td>
        `;
        rows.prepend(tr);
      }

      form.reset();
    } catch (err) {
      console.error(err);
      msg.textContent = '‚ùå –ü–æ–º–∏–ª–∫–∞: ' + (err.error || '–Ω–µ–≤—ñ–¥–æ–º–∞');
    }
  });
});
</script>
{% endblock %}
